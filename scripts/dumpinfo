#!/bin/bash
# Swizzin troubleshooting utility
# GPLv3, flying_sayusages for Swizzin 2020

# shellcheck source=sources/globals.sh
. /etc/swizzin/sources/globals.sh
# shellcheck source=sources/functions/utils
. /etc/swizzin/sources/functions/utils

# Processes stdin and posts it online
_post_content() {
	_wash_content | nc termbin.com 9999
	# _wash_content | less
}

# Removes any private info out of stdin
_wash_content() {
	sed "$sedString" | tr -d '\0'
}

_set_identifiable_values() {
	echo_progress_start "Constructing array for washing sensitive information"
	sensitive=()
	sensitive+=("$loguser" "USER")
	sensitive+=("$(_get_user_password "$loguser")" "PASSWORD")

	extip=$(curl -s -4 icanhazip.com | sed 's|\.|\\.|g')
	sensitive+=("$extip" "EXTIP")

	sensitive+=("$(ip route get 1 | sed -n 's/^.*src \([0-9.]*\) .*$/\1/p' | sed 's|\.|\\.|g')" "IPADDR")

	for domain in $(guess_domains | sed 's|\.|\\.|g'); do
		sensitive+=("$domain" "DOMAIN")
	done

	for hoststr in $(
		hostname -A | sed 's|\.|\\.|g'
		hostname -a | sed 's|\.|\\.|g'
	); do
		sensitive+=("$hoststr" "HOST")
	done

	sedString="$(printf 's/%s/###%s###/g; ' "${sensitive[@]}")"
	echo_progress_done "Array constructed"
}

#Holds whiptails
_make_app_choices() {
	# Get a list of installed apps to make logs for
	list_installed=($(find /install -type f -name .*.lock | awk -F. '{print $2}'))
	cmd=(whiptail --title "Choose apps to upload logs for" --separate-output --checklist "The logs for the selected applications will be included in the paste for your issue" 15 40 7)
	#shellcheck disable=2086 # The result is broken when it actually is quoted, we want the words to expand here.

	options=(journalctl "" off
		syslog "" off
		dmesg "" off)
	# readarray -t options < <(printf '%s\n""\nON\n' "${list_installed[@]}")
	for app in "${list_installed[@]}"; do
		options+=("$app" "" on)
	done
	choices=$("${cmd[@]}" "${options[@]}" 2>&1 > /dev/tty)
	exitstatus=$?
	if [ $exitstatus = 0 ]; then
		:
	else
		echo_warn "Upload cancelled"
		exit 1
	fi

	# Determine which users to uploads logs for when MU apps are being used
	readarray users < <(_get_nonmaster_list)
	if [[ ${#users[@]} -eq 0 ]]; then
		loguser=$(_get_master_username)
	else
		useroptions=("$(_get_master_username)" "" on)
		for u in "${users[@]}"; do
			useroptions+=("$u" "" off)
		done
		if ! loguser=$(whiptail --radiolist "Which user to upload the logs for their MU apps?" 9 40 2 "${useroptions[@]}" 2>&1 > /dev/tty); then
			echo_warn "Upload cancelled"
			exit 1
		fi
	fi
}

#Holds all the logic for creating the application logs array
_log_uploads() {
	echo_progress_start "Uploading logs to termbin..."
	# TODO maybe ensure only last N bytes are being sent in order not to hit the limit?
	logs_install="$(cat /root/logs/install.log | _post_content)"
	logs_swizzin=$(cat /root/logs/swizzin.log | _post_content)

	logs_app_list=()
	for choice in $choices; do
		paths=()    # Files to upload the content of
		commands=() # Commands to upload the ouptut of
		note=""     # A string to append behind each application row
		version=    # A string of the application version
		case $choice in
			journalctl)
				commands=('journalctl -xe')
				;;
			syslog)
				paths=('/var/log/syslog')
				;;
			dmesg)
				commands=('dmesg')
				;;
			qbittorrent)
				paths=("/home/$loguser/.local/share/data/qBittorrent/logs/qbittorrent.log")
				version="$(/usr/bin/qbittorrent-nox --version | awk {'print $2'})"
				;;
			nginx)
				commands=('nginx -T')
				paths=(/var/log/nginx/error.log)
				;;
			panel)
				commands=('journalctl -u panel')
				;;
			transmission)
				commands=('transmission-daemon --version')
				paths=("/home/$loguser/.config/transmission-daemon/config.json") # TODO is it?
				;;
			rtorrent)
				# commands=('rtorrent')
				paths=("/home/$loguser/.rtorrent.rc")
				;;
			*)
				echo_warn "No logs for $choice defined, please upload these manually"
				;;
		esac

		# Generating file to post
		tmpfile="/tmp/$choice"
		for cmdbruh in "${commands[@]}"; do
			{
				echo "#### Output of \"$cmdbruh\""
				$cmdbruh
				echo ""
			} >> "$tmpfile" 2>&1
		done

		for path in "${paths[@]}"; do
			{
				echo "#### Content of \"$path\""
				cat "$path"
				echo ""
			} >> "$tmpfile" 2>&1
		done

		link=
		if [[ -s "$tmpfile" ]]; then
			link=$(_post_content < "$tmpfile")
			rm "$tmpfile"
		else
			note="_(No logs generated for $choice)_"
		fi

		if [[ -n $version ]]; then
			logs_app_list+=("$choice ($version)" "$link" "$note")
		else
			logs_app_list+=("$choice" "$link" "$note")
		fi

	done
	echo_progress_done "Logs uploaded"
}

_output_discord() {
	echo_warn "Please paste everything between these lines into your issue
Make sure to replace the content where indicated, otherwise the issue might get automatically closed."
	echo "
**Apps:**		$(printf -- '`%s` ' "${list_installed[@]}")
**Server:**		$(_os_pretty), \`$(_os_arch)\`
**Git:**		$(git -C /etc/swizzin log -1 --pretty=format:'`(%h)` %s')
**Logs**
- Install logs: <${logs_install}>
- Swizzin logs: <${logs_swizzin}>
$(printf -- '- %s <%s> %s\n' "${logs_app_list[@]}")
"
}

_output_github() {
	echo_warn "Please paste everything between these lines into your issue
Make sure to replace the content where indicated, otherwise the issue might get automatically closed."
	echo "<!-- ---------------------------------------------------------- -->

## Installed swizzin apps
$(printf -- '- `%s`\n' "${list_installed[@]}")

## Server Info
- OS: $(_os_pretty)
- Arch: \`$(_os_arch)\`
- Hardware
$(dmidecode | grep -A3 '^System Information' | grep -v "System Information" | tr -d '\t' | sed 's/^/  - /')

## Swizzin version
$(git -C /etc/swizzin log -1 --pretty=format:"(%h) \`%s\` %d %an")

## Logs and output
- [Install logs](${logs_install})
- [Swizzin logs](${logs_swizzin})
$(printf -- '- [%s](%s) %s\n' "${logs_app_list[@]}")

<!-- ---------------------------------------------------------- -->"
}

_choose_destination() {
	if ! destination=$(whiptail --radiolist \
		"Where are you going to paste your info" 9 40 2 \
		"GitHub" "" ON \
		"Discord" "" OFF 2>&1 > /dev/tty); then
		echo_warn "Upload cancelled"
		exit 1
	fi

	echo_info "Generating dump for $destination"
}

_choose_destination
_make_app_choices
_set_identifiable_values
_log_uploads

if [[ $destination == "GitHub" ]]; then
	_output_github
else
	_output_discord
fi
